<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦æ°”åŠ é©¬</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            width: 100%;
            height: 100%; 
            overflow: hidden; 
            /* ä½¿ç”¨æ¥·ä½“æˆ–è¡¬çº¿å­—ä½“è¥é€ å¤é£æ„Ÿ */
            font-family: "STKaiti", "KaiTi", "PingFang SC", "Microsoft YaHei", serif; 
            background-color: #F4F0E6; /* å…œåº•èƒŒæ™¯è‰² */
            color: #8E6E43;
        }
        .bg {
            position: fixed; /* ä¿®å¤åº•éƒ¨ç™½è¾¹ï¼Œä½¿ç”¨ fixed è¦†ç›–å…¨å± */
            top: 0; left: 0; right: 0; bottom: 0;
            /* çº¸å¼ çº¹ç†èƒŒæ™¯è‰² + æŸ”å’Œæ¸å˜ */
            background: linear-gradient(180deg, #F4F0E6 0%, #E6DBC0 100%);
            /* å åŠ çº¹ç† */
            background-image: 
                radial-gradient(#D9CBAF 1px, transparent 1px),
                linear-gradient(180deg, #F4F0E6 0%, #E6DBC0 100%);
            background-size: 20px 20px, 100% 100%;
            z-index: -3;
        }
        
        /* åº•éƒ¨å®«æ®¿æ°›å›´è£…é¥° */
        .palace-deco {
            position: fixed; /* ä¿®å¤åº•éƒ¨ç™½è¾¹ */
            bottom: 0;
            left: 0;
            right: 0;
            height: 35vh;
            /* åº•éƒ¨æ·¡æ·¡çš„æœ±çº¢æ¸å˜ï¼Œå‘¼åº”æ•…å®«çº¢å¢™ï¼Œå¢åŠ å±‚æ¬¡ */
            background: linear-gradient(to top, rgba(168, 50, 50, 0.12) 0%, rgba(168, 50, 50, 0.05) 60%, transparent 100%);
            z-index: -1;
            pointer-events: none;
        }

        .overlay {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 14vh; /* å†…å®¹æ•´ä½“ä¸Šç§» */
            box-sizing: border-box;
            z-index: 1;
        }

        .main-title {
            font-size: 52px;
            font-weight: bold;
            line-height: 1.25;
            margin-bottom: 30px;
            text-align: center;
            color: #B58848; /* é‡‘è‰²æ ‡é¢˜ */
            /* æ¨¡æ‹Ÿä¹¦æ³•å­—ä½“çš„ç¬”è§¦æ„Ÿ */
            font-family: "STXingkai", "Xingkai SC", "STKaiti", "KaiTi", serif;
            text-shadow: 0 4px 8px rgba(181, 136, 72, 0.2);
            animation: fadeInUp 1.2s ease-out;
        }

        .subtitle-box {
            position: relative;
            border: 1px solid #B58848;
            padding: 10px 32px;
            border-radius: 50px;
            font-size: 17px;
            color: #8E6E43;
            margin-bottom: 80px;
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(181, 136, 72, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInUp 1.2s ease-out 0.3s backwards;
        }
        /* è£…é¥°æ€§ç¬¦å· */
        .subtitle-box::before, .subtitle-box::after {
            content: 'â–';
            color: #B58848;
            margin: 0 10px;
            font-size: 12px;
            opacity: 0.8;
        }
        /* åŒçº¿è¾¹æ¡†æ•ˆæœ */
        .subtitle-box .inner-border {
            position: absolute;
            top: 3px; left: 3px; right: 3px; bottom: 3px;
            border: 1px solid rgba(181, 136, 72, 0.3);
            border-radius: 46px;
            pointer-events: none;
        }

        .loading-area {
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ç§»é™¤å»¶è¿Ÿï¼Œç¡®ä¿æ–‡å­—ç«‹å³æ˜¾ç¤º */
            animation: fadeIn 0.5s ease-out;
        }

        .divider-text {
            font-size: 15px;
            color: #A08050;
            margin-bottom: 30px;
            letter-spacing: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            line-height: 1.6;
        }
        /* è£…é¥°çº¿ */
        .divider-line {
            width: 40px;
            height: 2px;
            background: #D4C4A8;
            margin: 10px 0;
            border-radius: 2px;
        }

        .btn { 
            display: inline-block; 
            width: 220px;
            padding: 15px 0; 
            /* æŒ‰é’®é‡‘è‰²æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(to bottom, #FDF5E6, #F0E0C0);
            border: 1px solid #D4B886;
            color: #8B5A2B; 
            text-decoration: none; 
            border-radius: 50px; 
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(139, 90, 43, 0.1);
            transition: all 0.3s;
            letter-spacing: 4px;
            text-align: center;
            font-family: "STKaiti", "KaiTi", serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            /* ç§»é™¤å‘¼å¸åŠ¨ç”»ï¼Œä¿æŒé™è°§ */
        }
        .btn:active { 
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(139, 90, 43, 0.15);
            background: linear-gradient(to bottom, #F0E0C0, #E6CBA6);
        }
        
        .loading-dots {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        .dot {
            width: 8px; height: 8px; background: #B58848; border-radius: 50%; margin: 0 6px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .debug-info { 
            position: fixed; 
            bottom: 10px; 
            width: 100%; 
            text-align: center; 
            font-size: 10px; 
            color: rgba(142, 110, 67, 0.3); 
            z-index: 10;
        }
        
        /* è°ƒè¯•æ§åˆ¶å°æ ·å¼ */
        .debug-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%; /* å æ®ä¸ŠåŠå± */
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 12px;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            z-index: 9999;
            display: none; /* é»˜è®¤éšè— */
            text-align: left;
            border-bottom: 2px solid #00ff00;
        }
        .debug-console.visible { display: block; }
        .log-line { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; word-break: break-all; }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-warn { color: #feca57; }
        
        /* è°ƒè¯•å¼€å…³æŒ‰é’® */
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            text-align: center;
            line-height: 36px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10000;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            transition: all 0.3s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰ debug=1 æ—¶æ˜¾ç¤º */
        }
        .debug-toggle:active { background: rgba(0, 0, 0, 0.5); transform: scale(0.95); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="bg"></div>
    <div class="palace-deco"></div>
    
    <div class="overlay">
        <!-- ä¸»æ ‡é¢˜ -->
        <div class="main-title">
            ç™¾å¹´æ•…å®«<br>ä¸ºä½ å®ˆæŠ¤
        </div>
        
        <!-- å‰¯æ ‡é¢˜/Slogan -->
        <div class="subtitle-box">
            <div class="inner-border"></div>
            è§£é”ä¸“å±ç‘å…½ï¼Œé›†æ•…å®«ç¥¥ç‘
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading-area">
            <div class="divider-text">
                æ­£åœ¨å¼€å¯<br>å¯»æ‰¾ä½ çš„ä¸“å±å®ˆæŠ¤ç‘å…½
                <div class="divider-line"></div>
            </div>
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>

        <!-- Manual Jump State -->
        <div id="manual" class="loading-area hidden">
            <div class="divider-text">
                å³åˆ»å¼€å¯<br>å¯»æ‰¾ä½ çš„ä¸“å±å®ˆæŠ¤ç‘å…½
                <div class="divider-line"></div>
            </div>
            <a id="manual-link" href="#" class="btn">å³åˆ»å¼€å¯</a>
        </div>

        <!-- Error State -->
        <div id="error" class="loading-area hidden">
            <div class="divider-text" id="error-msg" style="color: #D45848;">æ— æ³•è·å–è·³è½¬é“¾æ¥</div>
            <button class="btn" onclick="retry()">é‡è¯•</button>
        </div>
    </div>
    <div class="debug-info" id="debug-id"></div>
    <div id="debug-toggle" class="debug-toggle">ğŸ</div>
    <div id="debug-console" class="debug-console">
        <div style="color: #fff; border-bottom: 1px solid #fff; padding-bottom: 5px; margin-bottom: 5px;">ğŸ”§ è°ƒè¯•æ¨¡å¼å·²å¼€å¯</div>
    </div>

    <script>
        // ==========================================
        // ğŸ”§ é…ç½®åŒºåŸŸ (Configuration) - ä¸Šçº¿å‰è¯·æ£€æŸ¥
        // ==========================================
        const CONFIG = {
            // API æ¥å£åŸŸåï¼Œä¸Šçº¿æ—¶å¦‚æœåŸŸåå˜æ›´ï¼Œè¯·ä¿®æ”¹æ­¤å¤„
            API_HOST: 'https://api.thepalacemuseumculture.cn',
            
            // å°ç¨‹åºé¡µé¢è·¯å¾„
            WX_PATH: 'pages/index/index',
            
            // å°ç¨‹åºç¯å¢ƒç‰ˆæœ¬: release(æ­£å¼ç‰ˆ), trial(ä½“éªŒç‰ˆ), develop(å¼€å‘ç‰ˆ)
            // æ³¨æ„ï¼šå¦‚æœå°ç¨‹åºå°šæœªå‘å¸ƒæ­£å¼ç‰ˆï¼Œè¯·ä½¿ç”¨ 'trial' æˆ– 'develop'ï¼Œå¦åˆ™ä¼šæŠ¥é”™ "Generate Url Scheme Error"
            ENV_VERSION: 'trial'
        };
        // ==========================================

        // è·å– URL å‚æ•°
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // è°ƒè¯•æ—¥å¿—åŠŸèƒ½
        const consoleEl = document.getElementById('debug-console');
        const toggleEl = document.getElementById('debug-toggle');

        // å¦‚æœ URL å¸¦ debug=1ï¼Œæ˜¾ç¤ºè°ƒè¯•å¼€å…³
        if (getQueryParam('debug') === '1') {
            if (toggleEl) toggleEl.style.display = 'block';
        }

        // ç‚¹å‡»å¼€å…³åˆ‡æ¢æ˜¾ç¤º/éšè—
        if (toggleEl) {
            toggleEl.addEventListener('click', () => {
                consoleEl.classList.toggle('visible');
            });
        }

        function log(msg, type = 'info') {
            // åŒæ—¶ä¹Ÿè¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            if (type === 'error') console.error(msg);
            else console.log(msg);

            // å§‹ç»ˆè®°å½•æ—¥å¿—åˆ° DOMï¼Œä»¥ä¾¿å±•å¼€æ—¶æŸ¥çœ‹
            if (consoleEl) {
                const line = document.createElement('div');
                line.className = `log-line log-${type}`;
                const time = new Date().toLocaleTimeString();
                // å¦‚æœ msg æ˜¯å¯¹è±¡ï¼Œå°è¯• stringify
                let text = msg;
                if (typeof msg === 'object') {
                    try { text = JSON.stringify(msg); } catch(e) { text = '[Object]'; }
                }
                line.innerText = `[${time}] ${text}`;
                consoleEl.appendChild(line);
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showState(stateId) {
            log(`State change: -> ${stateId}`);
            ['loading', 'error', 'manual'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(stateId).classList.remove('hidden');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(msg, detail = null) {
            showState('error');
            // ç»Ÿä¸€å¯¹å¤–å±•ç¤ºæ–‡æ¡ˆï¼Œéšè—çœŸå®é”™è¯¯ä¿¡æ¯
            document.getElementById('error-msg').innerText = 'æœåŠ¡è¿æ¥ä¸ç¨³å®š\nè¯·ç¨åé‡è¯•';
            
            // å†…éƒ¨æ—¥å¿—è®°å½•çœŸå®é”™è¯¯ï¼Œæ–¹ä¾¿ Debug
            log(`[Error Hidden] ${msg}`, 'error');
            if (detail) log(detail, 'error');
        }

        // ä¸»é€»è¾‘
        async function init() {
            log('Init started...');
            showState('loading');
            
            const uuid = getQueryParam('uuid');
            const channel = getQueryParam('channel') || 'bracelet';
            log(`Params UUID: ${uuid}, Channel: ${channel}`);
            
            // æ˜¾ç¤ºè°ƒè¯•ID
            const debugEl = document.getElementById('debug-id');
            if (debugEl) debugEl.innerText = 'UUID: ' + (uuid || 'Unknown');

            if (!uuid) {
                showError('é“¾æ¥å‚æ•°ç¼ºå¤± (UUID)');
                return;
            }

            // æ„å»º API åœ°å€
            // æ³¨æ„ï¼šquery å‚æ•°ä¸­çš„ id=xxx ä¸éœ€è¦å†æ¬¡ encodeURIComponentï¼Œå› ä¸ºå®ƒæ˜¯ä½œä¸º query å‚æ•°çš„å€¼çš„ä¸€éƒ¨åˆ†
            // å®Œæ•´ç»“æ„: path=pages/index/index & query=id=... & env_version=release
            // æ”¹åŠ¨ï¼šquery=channel=bracelet&uuid=...
            // æ³¨æ„ï¼šç”±äºåŒ…å« & ç¬¦å·ï¼Œå¿…é¡»è¿›è¡Œ encodeURIComponentï¼Œå¦åˆ™ uuid ä¼šè¢«è¯†åˆ«ä¸º API çš„å‚æ•°è€Œä¸æ˜¯ query çš„ä¸€éƒ¨åˆ†
            const queryVal = `channel=${channel}&uuid=${uuid}`;
            const apiUrl = `${CONFIG.API_HOST}/wx/url_scheme?path=${CONFIG.WX_PATH}&query=${encodeURIComponent(queryVal)}&env_version=${CONFIG.ENV_VERSION}`;
            log(`Request URL: ${apiUrl}`);

            try {
                const response = await fetch(apiUrl);
                log(`Response Status: ${response.status}`);
                
                // ç½‘ç»œå±‚é¢çš„é”™è¯¯å¤„ç†
                if (!response.ok) {
                    throw new Error(`ç½‘ç»œè¯·æ±‚é”™è¯¯: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                log('Response Data:');
                log(data);

                // ä¸šåŠ¡å±‚é¢çš„åˆ¤æ–­
                if (data.url) {
                    // æˆåŠŸè·å– Scheme
                    const schemeUrl = data.url;
                    log(`Scheme URL: ${schemeUrl}`);
                    
                    // å°è¯•è‡ªåŠ¨è·³è½¬
                    log('Attempting auto redirect...');
                    window.location.href = schemeUrl;

                    // è®¾ç½®æ‰‹åŠ¨è·³è½¬é“¾æ¥ï¼Œä»¥é˜²è‡ªåŠ¨è·³è½¬å¤±è´¥ï¼ˆä¾‹å¦‚æµè§ˆå™¨æ‹¦æˆªï¼‰
                    const manualLink = document.getElementById('manual-link');
                    manualLink.href = schemeUrl;
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºæ‰‹åŠ¨è·³è½¬æŒ‰é’®ï¼Œå¦‚æœè‡ªåŠ¨è·³è½¬å¾ˆå¿«ç”Ÿæ•ˆï¼Œç”¨æˆ·å¯èƒ½çœ‹ä¸åˆ°è¿™ä¸ª
                    setTimeout(() => {
                        log('Showing manual button (timeout)');
                        showState('manual');
                    }, 1500);

                } else {
                    // æ¥å£è¿”å›é”™è¯¯ä¿¡æ¯
                    const errorMsg = data.msg || 'ç”Ÿæˆè·³è½¬é“¾æ¥å¤±è´¥';
                    log(`API Error: ${JSON.stringify(data)}`, 'error');
                    showError(errorMsg, data);
                }

            } catch (error) {
                log(`Fetch Exception: ${error.message}`, 'error');
                console.error('Fetch Error:', error);
                showError('ç½‘ç»œè¿æ¥ä¸ç¨³å®š\nè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', error.message);
            }
        }

        function retry() {
            init();
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.onload = init;
    </script>
</body>
</html>